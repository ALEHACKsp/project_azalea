# SConstruct file for the main kernel.

import os
import defaults

# Setup environment.
env = Environment()
defaults.setup_default_env(env)
env['CXXFLAGS'] = '-mno-red-zone -nostdlib -nostartfiles -nodefaultlibs -mcmodel=large -fno-exceptions -std=gnu++14 -U _LINUX -U __linux__ -D __MY_KERN'
env['CFLAGS'] = '-mno-red-zone -nostdlib -nostartfiles -nodefaultlibs -mcmodel=large -fno-exceptions -U _LINUX -U __linux__ -D __MY_KERN'
env['LINKFLAGS'] = "-T build_support/kernel_stage.ld --start-group"
env['LINK'] = 'ld -Map output/kernel_map.map'

# List of required components.
dependencies_in = ['#entry/SConscript',
                   '#processor/SConscript-generic',
                   '#processor/SConscript-x64',
                   '#klib/memory/SConscript',
                   '#klib/panic/SConscript',
                   '#mem/SConscript',
                   '#klib/c_helpers/SConscript',
                   '#klib/misc/SConscript',
                   '#klib/data_structures/SConscript',
                   '#klib/tracing/SConscript',
                   '#klib/synch/SConscript',
                   '#syscall/SConscript',
                   '#acpi/SConscript',
                   '#external/SConscript-ACPICA',
                   '#external/vsnprintf/Sconscript',
                  ]
                   
# Build components.
dependencies_out = [ ]

for dep in dependencies_in:
  out_dir = os.path.join('output', dep.strip('#'))
  dep_out = SConscript(dep, 'env', variant_dir=out_dir, duplicate=0)
  dependencies_out.append(dep_out)

env.Program("output/kernel64.sys", dependencies_out)
